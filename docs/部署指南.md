# 梦宙编年史 - 部署指南

## 一、项目概述

梦宙编年史是一款记录和分析梦境的微信小程序，具有以下功能：
- 梦境时间线展示
- AI生成梦境图片
- AI解梦分析
- 用户个人中心

## 二、开发环境要求

- 微信开发者工具最新版
- 腾讯云 CloudBase 账号
- 已开通云开发功能
- 已开通混元LLM和AI绘画服务

## 三、部署步骤

### 步骤1：导入项目

1. 打开微信开发者工具
2. 点击"导入项目"
3. 选择目录：`E:\open-code\mini\dream-universe`
4. AppID：`wxf8d3d3b246e3fb20`（或使用您自己的AppID）
5. 项目名称："梦宙编年史"

### 步骤2：配置云开发环境

1. 在微信开发者工具中，点击"云开发"按钮
2. 点击"开通云开发"，创建环境
3. 环境ID：`cloud1-3gzlpzydb805791e`
4. 创建成功后，确认环境ID与 `miniprogram/app.js` 中的一致

### 步骤3：创建数据库集合

在云开发控制台的"数据库"中，创建以下集合：

1. **users** - 用户表
2. **dreams** - 梦境表

### 步骤4：配置数据库权限

为 `users` 和 `dreams` 集合设置以下权限：

```json
{
  "read": "doc.openid == auth.openid",
  "write": "doc.openid == auth.openid"
}
```

### 步骤5：部署云函数

在微信开发者工具中，右键点击以下云函数目录，选择"上传并部署-云端安装依赖"：

1. `cloudfunctions/login/`
2. `cloudfunctions/getDreams/`
3. `cloudfunctions/createDream/`
4. `cloudfunctions/interpretDream/`
5. `cloudfunctions/updateUser/`

### 步骤6：开通AI服务

在腾讯云CloudBase控制台中，开通以下服务：

1. **混元LLM** - 用于优化图片提示词和解梦
   - 路径：云开发控制台 > 扩展能力 > AI扩展 > 混元
   - 点击"开通"并按照指引操作

2. **AI绘画** - 用于生成梦境图片
   - 路径：云开发控制台 > 扩展能力 > AI扩展 > AI绘画
   - 点击"开通"并按照指引操作

### 步骤7：配置云API权限

在云开发控制台的"云API密钥"中，确保以下API已开启：

- `llm.chat` - 混元LLM对话
- `aiArt.generate` - AI绘画生成

## 四、项目结构

```
dream-universe/
├── miniprogram/
│   ├── app.js              # 应用入口
│   ├── app.json            # 应用配置
│   ├── app.wxss            # 全局样式
│   ├── pages/
│   │   ├── index/          # 首页（梦境时间线）
│   │   ├── dream/          # 记录梦境
│   │   ├── interpret/      # AI解梦
│   │   └── profile/        # 个人中心
│   └── images/
│       └── icons/          # 图标资源
├── cloudfunctions/
│   ├── login/              # 登录认证
│   ├── getDreams/         # 获取梦境列表
│   ├── createDream/       # 创建梦境+生成图片
│   ├── interpretDream/    # AI解梦
│   └── updateUser/        # 更新用户信息
└── docs/
    └── prd/               # 需求文档
```

## 五、测试验证

### 功能测试清单

| 测试场景 | 预期结果 |
|---------|---------|
| 首次打开小程序 | 自动创建用户，获得随机昵称 |
| 记录梦境 | 生成1-3张AI图片 |
| 查看梦境时间线 | 按日期降序展示梦境 |
| 选择1-3条梦境解梦 | 返回深度解析结果 |
| 修改昵称 | 昵称更新成功 |

### 常见问题

**Q1: 云函数部署失败**
A: 确保已安装Node.js环境，右键云函数目录选择"上传并部署"时选择"云端安装依赖"。

**Q2: AI服务调用失败**
A: 检查CloudBase控制台中是否已开通混元LLM和AI绘画服务。

**Q3: 数据库查询为空**
A: 检查数据库权限设置，确保使用了`doc.openid == auth.openid`。

**Q4: 图片生成失败**
A: 检查AI绘画服务的配额和调用限制。

## 六、后续优化

- [ ] 梦境标签分类
- [ ] 梦境情绪标记
- [ ] 分享梦境到朋友圈
- [ ] 梦境统计报表
- [ ] 语音记录梦境
- [ ] 梦境相似度推荐

## 七、联系支持

如有技术问题，请检查：
1. 微信开发者工具控制台错误日志
2. 云开发控制台云函数日志
3. 腾讯云CloudBase帮助文档

## 八、MCP执行记录（本次已完成）

已通过 CloudBase MCP 完成以下配置校验与修复：

1. **环境登录与确认**
   - 当前环境：`cloud1-3gzlpzydb805791e`

2. **数据库集合状态检查**
   - `dreams`：已存在
   - `users`：已创建（本次通过 MCP 创建）

3. **安全规则校验与修复**
   - `dreams`：已设置为 `CUSTOM`
   - `users`：已设置为 `CUSTOM`
   - 规则内容：

```json
{
  "read": "doc.openid == auth.openid",
  "write": "doc.openid == auth.openid"
}
```

4. **UI重设计落地（不改业务逻辑）**
   - 全局主题与组件样式：`miniprogram/app.wxss`
   - 首页视觉与层级：`miniprogram/pages/index/index.wxml`、`miniprogram/pages/index/index.wxss`
   - 记录页视觉优化：`miniprogram/pages/dream/dream.wxml`、`miniprogram/pages/dream/dream.wxss`
   - 解梦页视觉优化：`miniprogram/pages/interpret/interpret.wxss`
   - 个人页视觉优化：`miniprogram/pages/profile/profile.wxml`、`miniprogram/pages/profile/profile.wxss`
   - 全局导航色系：`miniprogram/app.json`

> 说明：本次仅进行视觉层与云资源配置优化，未增加新功能，未变更既有云函数业务逻辑。

---

**文档版本**: v1.0  
**创建日期**: 2026-02-10  
**作者**: AI Assistant
